-- mpv-youtube-queue.lua
-- --
-- -- YouTube 'Add To Queue' for mpv
-- --
-- -- Copyright (C) 2023 sudacode
-- -- This program is free software: you can redistribute it and/or modify
-- -- it under the terms of the GNU General Public License as published by
-- -- the Free Software Foundation, either version 3 of the License, or
-- -- (at your option) any later version.
-- -- This program is distributed in the hope that it will be useful,
-- -- but WITHOUT ANY WARRANTY; without even the implied warranty of
-- -- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-- -- GNU General Public License for more details.
-- -- You should have received a copy of the GNU General Public License
-- -- along with this program.  If not, see <https://www.gnu.org/licenses/>.
-- local mp = require 'mp'
-- mp.options = require 'mp.options'
-- local utils = require 'mp.utils'
-- local assdraw = require 'mp.assdraw'
-- local styleOn = mp.get_property("osd-ass-cc/0")
-- local styleOff = mp.get_property("osd-ass-cc/1")
-- local YouTubeQueue = {}
-- local video_queue = {}
-- local MSG_DURATION = 1.5
-- local index = 0
-- local selected_index = 1
-- local display_offset = 0
-- local marked_index = nil
-- local current_video = nil
-- local destroyer = nil
-- local timeout
--
-- local options = {
--     add_to_queue = "ctrl+a",
--         download_current_video = "ctrl+d",
--             download_selected_video = "ctrl+D",
--                 move_cursor_down = "ctrl+j",
--                     move_cursor_up = "ctrl+k",
--                         move_video = "ctrl+m",
--                             play_next_in_queue = "ctrl+n",
--                                 open_video_in_browser = "ctrl+o",
--                                     open_channel_in_browser = "ctrl+O",
--                                         play_previous_in_queue = "ctrl+p",
--                                             print_current_video = "ctrl+P",
--                                                 print_queue = "ctrl+q",
--                                                     remove_from_queue = "ctrl+x",
--                                                         play_selected_video = "ctrl+ENTER",
--                                                             browser = "firefox",
--                                                                 clipboard_command = "xclip -o",
--                                                                     cursor_icon = "➤",
--                                                                         display_limit = 10,
--                                                                             download_directory = "~/videos/YouTube",
--                                                                                 download_quality = "720p",
--                                                                                     downloader = "curl",
--                                                                                         font_name = "JetBrains Mono",
--                                                                                             font_size = 12,
--                                                                                                 marked_icon = "⇅",
--                                                                                                     menu_timeout = 5,
--                                                                                                         show_errors = true,
--                                                                                                             ytdlp_file_format = "mp4",
--                                                                                                                 ytdlp_output_template = "%(uploader)s/%(title)s.%(ext)s"
--                                                                                                                 }
--                                                                                                                 mp.options.read_options(options, "mpv-youtube-queue")
--
--                                                                                                                 local function destroy()
--                                                                                                                     timeout:kill()
--                                                                                                                         mp.set_osd_ass(0, 0, "")
--                                                                                                                             destroyer = nil
--                                                                                                                             end
--
--                                                                                                                             timeout = mp.add_periodic_timer(options.menu_timeout, destroy)
--
--                                                                                                                             -- STYLE {{{
--                                                                                                                             local colors = {
--                                                                                                                                 error = "676EFF",
--                                                                                                                                     selected = "F993BD",
--                                                                                                                                         hover_selected = "FAA9CA",
--                                                                                                                                             cursor = "FDE98B",
--                                                                                                                                                 header = "8CFAF1",
--                                                                                                                                                     hover = "F2F8F8",
--                                                                                                                                                         text = "BFBFBF",
--                                                                                                                                                             marked = "C679FF"
--                                                                                                                                                             }
--
--                                                                                                                                                             local notransparent = "\\alpha&H00&"
--                                                                                                                                                             local semitransparent = "\\alpha&H40&"
--                                                                                                                                                             local sortoftransparent = "\\alpha&H59&"
--
--                                                                                                                                                             local style = {
--                                                                                                                                                                 error = "{\\c&" .. colors.error .. "&" .. notransparent .. "}",
--                                                                                                                                                                     selected = "{\\c&" .. colors.selected .. "&" .. semitransparent .. "}",
--                                                                                                                                                                         hover_selected = "{\\c&" .. colors.hover_selected .. "&\\alpha&H33&}",
--                                                                                                                                                                             cursor = "{\\c&" .. colors.cursor .. "&" .. notransparent .. "}",
--                                                                                                                                                                                 marked = "{\\c&" .. colors.marked .. "&" .. notransparent .. "}",
--                                                                                                                                                                                     reset = "{\\c&" .. colors.text .. "&" .. sortoftransparent .. "}",
--                                                                                                                                                                                         header = "{\\fn" .. options.font_name .. "\\fs" .. options.font_size * 1.5 ..
--                                                                                                                                                                                                 "\\u1\\b1\\c&" .. colors.header .. "&" .. notransparent .. "}",
--                                                                                                                                                                                                     hover = "{\\c&" .. colors.hover .. "&" .. semitransparent .. "}",
--                                                                                                                                                                                                         font = "{\\fn" .. options.font_name .. "\\fs" .. options.font_size .. "{" ..
--                                                                                                                                                                                                                 sortoftransparent .. "}"
--                                                                                                                                                                                                                 }
--                                                                                                                                                                                                                 -- }}}
--
--                                                                                                                                                                                                                 -- HELPERS {{{
--                                                                                                                                                                                                                 -- surround string with single quotes if it does not already have them
--                                                                                                                                                                                                                 local function surround_with_quotes(s)
--                                                                                                                                                                                                                     if string.sub(s, 0, 1) == "'" and string.sub(s, -1) == "'" then
--                                                                                                                                                                                                                             return s
--                                                                                                                                                                                                                                 else
--                                                                                                                                                                                                                                         return "'" .. s .. "'"
--                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                             local function remove_quotes(s) return string.gsub(s, "'", "") end
--
--                                                                                                                                                                                                                                             -- run sleep shell command for n seconds
--                                                                                                                                                                                                                                             local function sleep(n) os.execute("sleep " .. tonumber(n)) end
--
--                                                                                                                                                                                                                                             local function print_osd_message(message, duration, s)
--                                                                                                                                                                                                                                                 if s == style.error and not options.show_errors then return end
--                                                                                                                                                                                                                                                     destroy()
--                                                                                                                                                                                                                                                         if s == nil then s = style.font .. "{" .. notransparent .. "}" end
--                                                                                                                                                                                                                                                             if duration == nil then duration = MSG_DURATION end
--                                                                                                                                                                                                                                                                 mp.osd_message(styleOn .. s .. message .. style.reset .. styleOff .. "\n",
--                                                                                                                                                                                                                                                                         duration)
--                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                         -- returns true if the provided path exists and is a file
--                                                                                                                                                                                                                                                                         local function is_file(filepath)
--                                                                                                                                                                                                                                                                             local result = utils.file_info(filepath)
--                                                                                                                                                                                                                                                                                 if result == nil then return false end
--                                                                                                                                                                                                                                                                                     return result.is_file
--                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                     -- returns the filename given a path (e.g. /home/user/file.txt -> file.txt)
--                                                                                                                                                                                                                                                                                     local function split_path(filepath)
--                                                                                                                                                                                                                                                                                         if is_file(filepath) then return utils.split_path(filepath) end
--                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                         local function expanduser(path)
--                                                                                                                                                                                                                                                                                             -- remove trailing slash if it exists
--                                                                                                                                                                                                                                                                                                 if string.sub(path, -1) == "/" then path = string.sub(path, 1, -2) end
--                                                                                                                                                                                                                                                                                                     if path:sub(1, 1) == "~" then
--                                                                                                                                                                                                                                                                                                             local home = os.getenv("HOME")
--                                                                                                                                                                                                                                                                                                                     if home then
--                                                                                                                                                                                                                                                                                                                                 return home .. path:sub(2)
--                                                                                                                                                                                                                                                                                                                                         else
--                                                                                                                                                                                                                                                                                                                                                     return path
--                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                 else
--                                                                                                                                                                                                                                                                                                                                                                         return path
--                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                             local function open_url_in_browser(url)
--                                                                                                                                                                                                                                                                                                                                                                                 local command = options.browser .. " " .. surround_with_quotes(url)
--                                                                                                                                                                                                                                                                                                                                                                                     os.execute(command)
--                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                     local function open_video_in_browser()
--                                                                                                                                                                                                                                                                                                                                                                                         open_url_in_browser(current_video.video_url)
--                                                                                                                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                                                                                                                         local function open_channel_in_browser()
--                                                                                                                                                                                                                                                                                                                                                                                             open_url_in_browser(current_video.channel_url)
--                                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                                             local function _print_internal_playlist()
--                                                                                                                                                                                                                                                                                                                                                                                                 local count = mp.get_property_number("playlist-count")
--                                                                                                                                                                                                                                                                                                                                                                                                     print("Playlist contents:")
--                                                                                                                                                                                                                                                                                                                                                                                                         for i = 0, count - 1 do
--                                                                                                                                                                                                                                                                                                                                                                                                                 local uri = mp.get_property(string.format("playlist/%d/filename", i))
--                                                                                                                                                                                                                                                                                                                                                                                                                         print(string.format("%d: %s", i, uri))
--                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                             local function toggle_print()
--                                                                                                                                                                                                                                                                                                                                                                                                                                 if destroyer ~= nil then
--                                                                                                                                                                                                                                                                                                                                                                                                                                         destroyer()
--                                                                                                                                                                                                                                                                                                                                                                                                                                             else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                     YouTubeQueue.print_queue()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                         -- }}}
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                         -- QUEUE GETTERS AND SETTERS {{{
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                         function YouTubeQueue.get_video_at(idx)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                             if idx <= 0 or idx > #video_queue then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                     print_osd_message("Invalid video index", MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return video_queue[idx]
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -- returns the content of the clipboard
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     function YouTubeQueue.get_clipboard_content()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         local command, args = options.clipboard_command:match("(%S+)%s+(%S+)")
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local res = mp.command_native({
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     name = "subprocess",
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             playback_only = false,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     capture_stdout = true,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             args = { command, args }
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 })
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if res.status ~= 0 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print_osd_message("Failed to get clipboard content", MSG_DURATION,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return res.stdout
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function YouTubeQueue.get_video_info(url)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local res = mp.command_native({
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     name = "subprocess",
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             playback_only = false,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     capture_stdout = true,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             args = {
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "yt-dlp", "--print", "channel_url", "--print", "uploader",
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "--print", "title", "--playlist-items", "1", url
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 })
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if res.status ~= 0 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print_osd_message("Failed to get video info", MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local channel_url, uploader, title = res.stdout:match("(.*)\n(.*)\n(.*)\n")
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if channel_url == nil or uploader == nil or title == nil or channel_url ==
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "" or uploader == "" or title == "" then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print_osd_message("Failed to get video info", MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return channel_url, uploader, title
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function YouTubeQueue.print_current_video()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destroy()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         local current = current_video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if is_file(current.video_url) then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     print_osd_message("Playing: " .. current.video_name, 3)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print_osd_message("Playing: " .. current.video_name .. ' by ' ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             current.channel_name, 3)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- }}}
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- QUEUE FUNCTIONS {{{
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- Function to set the next or previous video in the queue as the current video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- direction can be "NEXT" or "PREV".  If nil, "next" is assumed
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- Returns nil if there are no more videos in the queue
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function YouTubeQueue.set_video(direction)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     local amt
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         direction = string.upper(direction)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (direction == "NEXT" or direction == nil) then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     amt = 1
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         elseif (direction == "PREV" or direction == "PREVIOUS") then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 amt = -1
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print_osd_message("Invalid direction: " .. direction, MSG_DURATION,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if index + amt > #video_queue or index + amt == 0 then return nil end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             index = index + amt
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 selected_index = index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     current_video = video_queue[index]
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return current_video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function YouTubeQueue.is_in_queue(url)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             for _, v in ipairs(video_queue) do
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if v.video_url == url then return true end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return false
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -- Function to find the index of the currently playing video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             function YouTubeQueue.update_current_index()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if #video_queue == 0 then return end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     local current_url = mp.get_property("path")
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         for i, v in ipairs(video_queue) do
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if v.video_url == current_url then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             index = i
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         selected_index = index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     current_video = YouTubeQueue.get_video_at(index)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- if not found, reset the index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     index = 0
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     function YouTubeQueue.mark_and_move_video()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if marked_index == nil and selected_index ~= index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- Mark the currently selected video for moving
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         marked_index = selected_index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -- Move the previously marked video to the selected position
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             YouTubeQueue.reorder_queue(marked_index, selected_index)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -- print_osd_message("Video moved to the selected position.", 1.5)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             marked_index = nil -- Reset the marked index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -- Refresh the queue display
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         YouTubeQueue.print_queue()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function YouTubeQueue.reorder_queue(from_index, to_index)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if from_index == to_index or to_index == index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     print_osd_message("No changes made.", 1.5)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -- Check if the provided indices are within the bounds of the video_queue
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if from_index > 0 and from_index <= #video_queue and to_index > 0 and
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 to_index <= #video_queue then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -- move the video from the from_index to to_index in the internal playlist.
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -- playlist-move is 0-indexed
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if from_index < to_index and to_index == #video_queue then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     mp.commandv("playlist-move", from_index - 1, to_index)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             elseif from_index < to_index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         mp.commandv("playlist-move", to_index - 1, from_index - 1)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             mp.commandv("playlist-move", from_index - 1, to_index - 1)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -- Remove from from_index and insert at to_index into YouTubeQueue
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     local temp_video = video_queue[from_index]
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             table.remove(video_queue, from_index)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     table.insert(video_queue, to_index, temp_video)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print_osd_message("Invalid indices for reordering. No changes made.",
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function YouTubeQueue.print_queue(duration)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     timeout:kill()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         timeout:resume()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local ass = assdraw.ass_new()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 local current_index = index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if #video_queue > 0 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local half_limit = math.floor(options.display_limit / 2)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     local start_index, end_index
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if selected_index <= half_limit then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         start_index = 1
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             start_index = selected_index - half_limit
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end_index = start_index + options.display_limit - 1
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if end_index > #video_queue then end_index = #video_queue end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ass:append(
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         style.header .. "MPV-YOUTUBE-QUEUE{\\u0\\b0}" .. style.reset ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     style.font .. "\n")
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             local message
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     for i = start_index, end_index do
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 local prefix = (i == selected_index) and style.cursor ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 options.cursor_icon .. "\\h" .. style.reset or
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "\\h\\h\\h"
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if i == current_index and i == selected_index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             message = prefix .. style.hover_selected .. i .. ". " ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 video_queue[i].video_name .. " - (" ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     video_queue[i].channel_name .. ")" .. style.reset
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 elseif i == current_index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 message = prefix .. style.selected .. i .. ". " ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     video_queue[i].video_name .. " - (" ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         video_queue[i].channel_name .. ")" .. style.reset
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     elseif i == selected_index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     message = prefix .. style.hover .. i .. ". " ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         video_queue[i].video_name .. " - (" ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             video_queue[i].channel_name .. ")" .. style.reset
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         message = prefix .. style.reset .. i .. ". " ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             video_queue[i].video_name .. " - (" ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 video_queue[i].channel_name .. ")" .. style.reset
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if i == marked_index then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         message =
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             message .. " " .. style.marked .. options.marked_icon ..
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 style.reset .. "\n"
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             message = message .. "\n"
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ass:append(style.font .. message)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     mp.set_osd_ass(0, 0, ass.text)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if duration ~= nil then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         mp.add_timeout(duration, function() destroy() end)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     else
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print_osd_message("No videos in the queue or history.", duration,
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 destroyer = destroy
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function YouTubeQueue.move_cursor(amt)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     timeout:kill()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         timeout:resume()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             selected_index = selected_index - amt
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if selected_index < 1 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         selected_index = 1
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             elseif selected_index > #video_queue then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     selected_index = #video_queue
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if amt == 1 and selected_index > 1 and selected_index < display_offset + 1 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     display_offset = display_offset - math.abs(selected_index - amt)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         elseif amt == -1 and selected_index < #video_queue and selected_index >
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 display_offset + options.display_limit then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         display_offset = display_offset + math.abs(selected_index - amt)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 YouTubeQueue.print_queue()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function YouTubeQueue.play_video_at(idx)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if idx <= 0 or idx > #video_queue then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print_osd_message("Invalid video index", MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return nil
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             index = idx
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 selected_index = idx
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     mp.set_property_number("playlist-pos", index - 1) -- zero-based index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         YouTubeQueue.print_current_video()
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return current_video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -- play the next video in the queue
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             function YouTubeQueue.play_video(direction)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 direction = string.upper(direction)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     local video = YouTubeQueue.set_video(direction)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if video == nil then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print_osd_message("No video available.", MSG_DURATION, style.error)
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             end
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 current_video = video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     selected_index = index
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -- if the current video is not the first in the queue, then play the video
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -- else, check if the video is playing and if not play the video with replace
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if direction == "NEXT" and #video_queue > 1 then
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         YouTubeQueue.play_video_}}}"'")}}}"}"}}}}
